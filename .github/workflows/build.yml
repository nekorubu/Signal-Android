# Original script written by The-Hypervisor
name: build

on:
  push:
    branches-ignore:
    - main

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true
          
    - name: Increase swapfile
      run: |
        export SWAP_FILE=$(swapon --show=NAME | tail -n 1)
        sudo swapoff $SWAP_FILE
        sudo rm $SWAP_FILE
        sudo fallocate -l 8192M $SWAP_FILE
        sudo chmod 600 $SWAP_FILE
        sudo mkswap $SWAP_FILE
        sudo swapon $SWAP_FILE

    - name: set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: 17
        cache: gradle

    - name: Validate Gradle Wrapper
      uses: gradle/wrapper-validation-action@v1

    - name: Build with Gradle
      run: ./gradlew assemblePlayProdRelease --parallel

    - name: Get version
      id: get-version
      run: echo ::set-output name=VERSION::${GITHUB_REF#refs/heads/}

    - name: Sign APKs
      uses: ilharp/sign-android-release@v1.0.4
      with:
        releaseDir: app/build/outputs/apk/playProd/release
        signingKey: ${{ secrets.KEYSTORE }}
        keyAlias: ${{ secrets.ALIAS }}
        keyStorePassword: ${{ secrets.PASS }}
        keyPassword: ${{ secrets.PASS }}
        buildToolsVersion: 33.0.0

    - name: Rename APKs
      run: |
        mkdir app/build/outputs/apk/playProd/release/signed
        mv app/build/outputs/apk/playProd/release/*-signed* app/build/outputs/apk/playProd/release/signed 
      
    - name: Create Release And Upload
      uses: ncipollo/release-action@v1
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        tag: "v${{ steps.get-version.outputs.VERSION }}"
        artifacts: app/build/outputs/apk/playProd/release/signed/Signal*universal*.apk    

    - name: Archive reports for failed build
      if: ${{ failure() }}
      uses: actions/upload-artifact@v4
      with:
        name: reports
        path: '*/build/reports'
